# プロダクト要求定義書

## プロダクトビジョンと目的

### プロダクト名
**ttlx** (Tera Term Language eXtended)

### ビジョン
Tera Termマクロ（TTL）における再利用性を向上させ、同じ処理を何度も繰り返し記述する手間をなくす。

### 目的
- **主要課題の解決**: 共通処理や設定を外部化し、複数のTTLスクリプト間で再利用可能にする
- **MVPの焦点**: まずSSH接続（踏み台サーバー経由の多段接続）に特化し、接続設定とコマンド実行の再利用性を実現する
- **将来の展望**: Tera Term Language全般（ファイル転送、ダイアログ表示、変数操作など）の宣言的記述をサポートする
- **宣言的な記述**: 複雑な手続き的処理を、設定ファイルで簡潔に表現できるようにする
- **設定形式の選定理由**: プログラミングスキルを持たないエンジニアでも扱いやすいYAML形式を採用する
- **TTL自動生成**: YAML設定ファイルから、エラーハンドリングやリトライ処理を含む高品質なTTLスクリプトを生成する
- **重要**: ttlx自体はTera Termの機能を実装せず、TTLを生成するだけ（車輪の再発明をしない）

---

## ターゲットユーザーと課題・ニーズ

### ターゲットユーザー
- Tera Termを使用するすべてのエンジニア
  - インフラエンジニア
  - ネットワークエンジニア
  - サーバー管理者
  - 開発者
  - オペレーター
- **前提条件**: プログラミングスキルを必要としない設計

### ユーザーの課題
1. **スクリプトの再利用性が低い（最重要課題）**
   - 同じ処理（接続設定、コマンドシーケンスなど）を複数のスクリプトで使い回す場合、毎回同じ記述をコピー&ペーストする必要がある
   - 処理内容の変更時に、複数のスクリプトを修正する必要がある
   - **MVPでの具体例**: 踏み台サーバーの接続情報を、すべてのスクリプトに重複して記述している

2. **手続き的なTTLスクリプトの記述が煩雑**
   - 複雑な処理を実現するには、低レベルな手続きを細かく記述する必要がある
   - エラーハンドリングやリトライ処理を自前で実装する必要がある
   - **MVPでの具体例**: 多段SSH接続を実現するには、接続・認証・コマンド送信を手続き的に記述する必要がある

3. **スクリプトの保守性が低い**
   - TTLスクリプトは可読性が低く、変更の影響範囲が分かりにくい
   - 変更前後の差分を確認する手段がない

### ユーザーのニーズ
1. **共通処理を再利用したい（最重要ニーズ）**
   - よく使う処理をプロファイルやテンプレートとして定義し、複数のスクリプトで使い回したい
   - 共通処理を一箇所で管理し、変更時の修正箇所を最小限にしたい
   - **MVPでの具体例**: 踏み台サーバーの接続設定をプロファイルとして定義し、複数のスクリプトで参照したい

2. **宣言的な設定で処理を定義したい**
   - 複雑な手続きを、YAMLなどの設定ファイルで簡潔に表現したい
   - **MVPでの具体例**: どのサーバーにどの順序で接続するかを、設定ファイルで定義したい

3. **変更の影響範囲を確認したい**
   - 設定ファイルを変更した際に、生成されるTTLスクリプトの差分を確認したい

---

## 主要な機能一覧

### MVP機能（Phase 1）
1. YAML設定ファイルの読み込み
2. 基本的な多段SSH接続（2段のみ）の定義
3. パスワード認証・公開鍵認証の両対応
4. 接続後の任意コマンド実行
5. TTLスクリプトの生成
6. 基本的なバリデーション（YAML構文チェック、必須項目チェック）

### Phase 2機能
1. 3段以上の多段SSH接続
2. プロファイルのインポート機能
3. エラーハンドリングオプション（タイムアウト、リトライ、エラー時の動作）
4. 対話的セットアップ（`ttlx init`）
5. 変数展開機能（環境変数、テンプレート変数）
6. **TTL差分表示機能**（設定変更前後のTTL比較）

### Phase 3機能（将来的）
1. コマンドテンプレート機能
2. ドキュメント自動生成
3. IDE拡張（VSCode）
4. 設定ファイルの暗号化機能

---

## 成功の定義

- プログラミング経験が少ないユーザーでも、10分以内に最初のTTLを生成できる
- ユーザーが「分かりやすい」「使いやすい」と感じるCLIインターフェース
- 生成されたTTLスクリプトが、手作業で書いたものより読みやすく保守しやすい
- 共通処理の再利用により、スクリプト保守の手間が大幅に削減される

---

## ビジネス要件

### 優先度
- 多段SSH接続の簡潔な記述（高）
- プロファイル管理による再利用性（高）
- バリデーション機能（中）
- 差分表示機能（中）
- IDE拡張（低）

### 制約事項
- ttlx自体はSSH接続機能を実装しない（Tera Termに依存）
- 生成されるTTLは、Tera Term 4.x系および5.x系で動作すること
- クロスプラットフォーム対応（Windows、macOS、Linux）

---

## ユーザーストーリー

### US-001: 多段SSH接続の定義
**As a** インフラエンジニア

**I want to** YAML設定ファイルで踏み台サーバー経由の接続を定義できる

**So that** 手続き的なTTLスクリプトを書かずに済む

**受け入れ条件:**
- YAML設定ファイルで、接続プロファイル（ホスト名、ユーザー名、認証方式）を定義できる
- 複数のプロファイルを順序付きリストで定義することで、多段接続を表現できる
- 生成されたTTLスクリプトが、Tera Termで正常に実行できる

---

### US-002: パスワード認証と公開鍵認証の対応
**As a** サーバー管理者

**I want to** パスワード認証と公開鍵認証の両方を使用できる

**So that** 様々な認証方式のサーバーに対応できる

**受け入れ条件:**
- パスワード認証を指定できる（実行時入力、環境変数、直接記述）
- 公開鍵認証を指定できる（秘密鍵ファイルのパス指定）
- 認証方式をプロファイルごとに個別に設定できる

---

### US-003: 接続後のコマンド実行
**As a** オペレーター

**I want to** 接続後に実行するコマンドを定義できる

**So that** サーバー操作を自動化できる

**受け入れ条件:**
- YAML設定ファイルで、実行するコマンドをリストで定義できる
- コマンドは定義した順序で実行される
- コマンド実行後の待機時間を設定できる（オプション）

---

### US-004: TTLスクリプトの生成
**As a** 全てのユーザー

**I want to** `ttlx build` コマンドでTTLスクリプトを生成できる

**So that** Tera Termで実行できるスクリプトを得られる

**受け入れ条件:**
- `ttlx build <config.yml>` でTTLスクリプトが生成される
- 生成されたTTLファイルには、コメントで元の設定ファイル名と生成日時が記載される
- 出力先を指定できる（`-o` オプション）

---

### US-005: 設定ファイルのバリデーション
**As a** 全てのユーザー

**I want to** 設定ファイルの構文エラーを事前に検出できる

**So that** TTL生成前に問題を修正できる

**受け入れ条件:**
- `ttlx validate <config.yml>` でバリデーションを実行できる
- 構文エラー、必須項目の欠落、不正な値を検出できる
- エラーメッセージは分かりやすく、修正方法を示唆する

---

### US-006: プロファイルの再利用（Phase 2）
**As a** インフラエンジニア

**I want to** よく使う接続先をグローバルプロファイルとして定義し、複数の設定ファイルで使い回せる

**So that** 同じ接続設定を何度も書かずに済む

**受け入れ条件:**
- グローバルプロファイルファイル（例: `~/.ttlx/profiles.yml`）を作成できる
- プロジェクト固有の設定ファイルから、グローバルプロファイルをインポートできる
- プロファイル名が重複した場合、ローカル設定が優先される

---

### US-007: TTL差分表示（Phase 2）
**As a** 全てのユーザー

**I want to** 設定ファイル変更前後のTTL差分を確認できる

**So that** 変更の影響範囲を把握できる

**受け入れ条件:**
- `ttlx diff <config.yml>` で、前回生成時との差分を表示できる
- 差分はgit diff形式で表示される
- 設定レベルの差分（どのプロファイルが変更されたか）も表示される

---

## 機能要件

### FR-001: YAML設定ファイルのスキーマ定義
- バージョン番号（`version`）
- プロファイル定義（`profiles`）
  - ホスト名（`host`）
  - ポート番号（`port`、デフォルト: 22）
  - ユーザー名（`user`）
  - 認証設定（`auth`）
    - 認証タイプ（`type`: password | keyfile）
    - パスワード関連（`value` | `env` | `prompt`）
    - 鍵ファイルパス（`path`）
- 接続ルート（`route`）
- コマンドリスト（`commands`）
- オプション設定（`options`）
  - タイムアウト（`timeout`）
  - リトライ回数（`retry`）
  - ログ取得（`log`、`log_file`）

### FR-002: TTL生成ロジック
- YAML設定を解析し、TTLスクリプトを生成する
- 生成されるTTLには、以下を含む：
  - コメントヘッダー（生成元、生成日時）
  - エラーハンドリングコード（接続失敗、タイムアウト）
  - 各段階の接続処理
  - コマンド実行処理
  - 正常終了・異常終了の処理

### FR-003: CLIコマンド仕様
- `ttlx build <config.yml> [-o output.ttl]`
- `ttlx validate <config.yml>`
- `ttlx diff <config.yml>` (Phase 2)
- `ttlx init` (Phase 2)
- `ttlx list` (Phase 2)
- `ttlx profiles` (Phase 2)

---

## 非機能要件

### NFR-001: パフォーマンス
- 設定ファイルの読み込みから TTL生成まで、1秒以内に完了する（100KB以下のYAMLファイル）

### NFR-002: 可用性
- 生成されたTTLスクリプトは、Tera Term 4.106以降で動作する

### NFR-003: 保守性
- コードは型安全な言語で実装する（Python with type hints、Go、Rustなど）
- ユニットテストカバレッジ80%以上

### NFR-004: セキュリティ
- パスワードを設定ファイルに平文で記述することを推奨しない（警告を表示）
- 環境変数からパスワードを読み込む機能を提供する
- 生成されたTTLファイルにパスワードが含まれる場合、ファイルパーミッションを警告する

### NFR-005: ユーザビリティ
- エラーメッセージは日本語・英語の両方をサポートする
- ヘルプメッセージ（`--help`）は分かりやすく、例を含む

---

## 対象外（Out of Scope）

- SSH接続機能の実装（Tera Termに委譲）
- Tera Term以外の端末エミュレータのサポート
- TTL以外の出力形式（例: Expect、PowerShellスクリプト）
- GUI アプリケーションの提供
- Web UIの提供
